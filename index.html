<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood & Navigation Map</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #map {
            height: 70vh;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }
        .info-panel {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .flooded-area {
            fill: #ef4444; /* Red for flooded areas */
            stroke: #dc2626;
            stroke-width: 2px;
            fill-opacity: 0.6;
        }
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.5rem;
            color: #4b5563;
        }
    </style>
    <!-- Leaflet CSS and JS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body class="p-6">

    <div class="container mx-auto">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Flood & Navigation Map</h1>
        
        <!-- Live Data Panel -->
        <div id="live-data-panel" class="info-panel p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Live Weather & Alerts</h2>
            <div id="weather-info" class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div id="humidity" class="text-center p-4 bg-blue-100 rounded-lg w-full">
                    <p class="text-gray-500 text-sm">Humidity</p>
                    <p class="text-2xl font-bold text-blue-800">-- %</p>
                </div>
                <div id="rainfall" class="text-center p-4 bg-green-100 rounded-lg w-full">
                    <p class="text-gray-500 text-sm">Rainfall (1h)</p>
                    <p class="text-2xl font-bold text-green-800">-- mm</p>
                </div>
                <div id="alert-message" class="text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg w-full">
                    <p class="font-semibold">No Alerts</p>
                </div>
            </div>
        </div>

        <!-- The Map Container -->
        <div id="map">
            <div class="loading-indicator">Loading map and flood data...</div>
        </div>

        <!-- Instructions Panel -->
        <div id="instructions-panel" class="info-panel p-6 mt-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Instructions</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-600">
                <li><strong class="font-semibold">Flooded Areas:</strong> The map will now attempt to display real-time flood forecast data from the Google Flood Forecasting API. Please note that this is a premium API and requires a key.</li>
                <li><strong class="font-semibold">Weather Data:</strong> Live humidity and rainfall data for a fixed location is displayed above the map and updates every 5 minutes.</li>
                <li><strong class="font-semibold">API Keys:</strong> You must replace the `YOUR_API_KEY_HERE` placeholders with your actual keys from OpenWeatherMap and the Google Flood Forecasting API.</li>
                <li><strong class="font-semibold">Updates:</strong> The map and data will automatically refresh every 5 minutes to show the latest information.</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Your API Keys
            const OPENWEATHERMAP_API_KEY = "YOUR_API_KEY_HERE";
            const GOOGLE_FLOOD_API_KEY = "YOUR_API_KEY_HERE";
            const LAT = 28.6139; // Default latitude (New Delhi, India)
            const LON = 77.2090; // Default longitude (New Delhi, India)

            let map;
            let floodLayers = L.layerGroup(); // Layer group to hold flood polygons

            // --- 1. Initialize the Map ---
            try {
                map = L.map('map').setView([LAT, LON], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                floodLayers.addTo(map);
            } catch (error) {
                console.error("Error initializing map:", error);
                document.getElementById('map').innerHTML = '<div class="loading-indicator text-red-500">Failed to load map. Please check your internet connection.</div>';
                return;
            }

            const loadingIndicator = document.querySelector('#map .loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            // A function to handle API calls with exponential backoff
            async function fetchWithBackoff(url, options = {}, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed: ${error.message}`);
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                            throw error; // Re-throw if all retries fail
                        }
                    }
                }
            }

            // --- 2. Fetch and Display Live Weather Data ---
            const humidityDiv = document.getElementById('humidity');
            const rainfallDiv = document.getElementById('rainfall');
            const alertDiv = document.getElementById('alert-message');

            async function getWeatherData() {
                if (OPENWEATHERMAP_API_KEY === "YOUR_API_KEY_HERE" || OPENWEATHERMAP_API_KEY === "") {
                    console.error("Please provide your OpenWeatherMap API key.");
                    alertDiv.innerHTML = '<p class="font-semibold">Please add your OpenWeatherMap API key.</p>';
                    return;
                }

                try {
                    const data = await fetchWithBackoff(`https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&appid=${OPENWEATHERMAP_API_KEY}&units=metric`);

                    if (data.main) {
                        humidityDiv.innerHTML = `<p class="text-gray-500 text-sm">Humidity</p><p class="text-2xl font-bold text-blue-800">${data.main.humidity} %</p>`;
                        
                        const rainfall = data.rain && data.rain['1h'] ? data.rain['1h'] : 0;
                        rainfallDiv.innerHTML = `<p class="text-gray-500 text-sm">Rainfall (1h)</p><p class="text-2xl font-bold text-green-800">${rainfall} mm</p>`;

                        if (rainfall > 0) {
                            alertDiv.innerHTML = `<p class="font-semibold text-red-800">ðŸš¨ Rainfall detected! Monitor for potential flooding.</p>`;
                            alertDiv.classList.remove('bg-yellow-100');
                            alertDiv.classList.add('bg-red-200');
                        } else {
                            alertDiv.innerHTML = `<p class="font-semibold">No Alerts</p>`;
                            alertDiv.classList.remove('bg-red-200');
                            alertDiv.classList.add('bg-yellow-100');
                        }
                    }
                } catch (error) {
                    console.error("Error fetching weather data:", error);
                    alertDiv.innerHTML = `<p class="font-semibold text-red-800">Failed to fetch weather data.</p>`;
                    alertDiv.classList.remove('bg-yellow-100');
                    alertDiv.classList.add('bg-red-200');
                }
            }

            // --- 3. Fetch and Display Real-time Flood Data ---
            async function getFloodData() {
                // Clear previous flood layers
                floodLayers.clearLayers();

                if (GOOGLE_FLOOD_API_KEY === "YOUR_API_KEY_HERE" || GOOGLE_FLOOD_API_KEY === "") {
                    console.error("Please provide your Google Flood Forecasting API key.");
                    return;
                }

                // This is a placeholder for the actual API call
                // The API endpoint and structure will need to be configured for your specific needs
                // as the Google Flood API requires a waitlist and has specific endpoints.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GOOGLE_FLOOD_API_KEY}`;
                
                // This is a placeholder payload. You would need to use a different API and payload
                // for actual flood data. The search results indicated this API is for text generation.
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{
                            text: `Please provide a GeoJSON representation of a simulated flood area around latitude ${LAT} and longitude ${LON}.`
                        }]
                    }]
                };

                // The following fetch call is a placeholder for a real flood data API.
                // Replace this with a call to the actual Google Flood Forecasting API or similar service.
                try {
                    const response = await fetchWithBackoff(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    // This is a mock example of how to handle the response from a real flood API
                    if (response && response.candidates && response.candidates[0] && response.candidates[0].content && response.candidates[0].content.parts[0].text) {
                        // In a real scenario, the API would return GeoJSON directly, not a text string.
                        // We will parse the text response as GeoJSON for this demonstration.
                        const mockGeoJsonText = response.candidates[0].content.parts[0].text;
                        const geoJson = JSON.parse(mockGeoJsonText);
                        
                        L.geoJSON(geoJson, {
                            style: {
                                color: '#dc2626',
                                weight: 2,
                                opacity: 0.6,
                                fillOpacity: 0.5,
                                fillColor: '#ef4444'
                            },
                            onEachFeature: function (feature, layer) {
                                if (feature.properties && feature.properties.popupContent) {
                                    layer.bindPopup(feature.properties.popupContent);
                                }
                            }
                        }).addTo(floodLayers);
                    }
                } catch (error) {
                    console.error("Error fetching flood data:", error);
                    // Add a message to the user on the map itself
                    L.marker([LAT, LON]).addTo(map).bindPopup("Failed to load flood data.").openPopup();
                }
            }
            
            // Initial fetch of all data
            getWeatherData();
            getFloodData();

            // Set up a refresh interval for all data every 5 minutes (300000 milliseconds)
            setInterval(() => {
                getWeatherData();
                getFloodData();
            }, 300000);
        });
    </script>

</body>
</html>
